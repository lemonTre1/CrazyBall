using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Networking;


public class PlayerController :  NetworkBehaviour{
    
    public PlayerAttributes m_PlayerAttributes;

    Text PlayerNameText;
    Text AttributeText;
    Rigidbody m_rigidbody;

    void Start()
    {
        m_rigidbody = GetComponent<Rigidbody>();
    }

    public override void OnStartLocalPlayer()
    {
        base.OnStartLocalPlayer();
        CmdCreatMap(LobbyUI._Instance.mapInfo,LobbyUI._Instance.m_vecotr2);
        gameObject.AddComponent<SkillController>();
        Init();
    }

    void Init()
    {
        int playerID = playerControllerId + 1;
        Camera.main.GetComponent<Camerafollow>().target = transform.gameObject;
      
        m_PlayerAttributes = new PlayerAttributes("player0" + playerID, 1, 1, 1);
        m_PlayerAttributes.MaxSpeed = 20;
        m_PlayerAttributes.ExpansionMultiple = 1;

        PlayerNameText = ReferenceManager.instance.PersonInfoPanel.transform.Find("PersonName").GetComponentInChildren<Text>();
        AttributeText = ReferenceManager.instance.PersonInfoPanel.transform.Find("attribute").GetComponent<Text>();
      
        transform.GetComponent<MeshRenderer>().material.mainTexture = Resources.Load<Texture>("ball/0" + playerID);
        UpdateAttribute();
    }

    public void UpdateAttribute()
    {
        PlayerNameText.text = m_PlayerAttributes.PlayerName;
        AttributeText.text = "力：" + m_PlayerAttributes.PowerValue +
               " 体：" + m_PlayerAttributes.StrengthValue +
               " 智：" + m_PlayerAttributes.IntelligenceValue + "";
        //transform.localScale = new Vector3(0.5f, 0.5f, 0.5f) * m_PlayerAttributes.ExpansionMultiple;

        //m_rigidbody.mass = m_PlayerAttributes.StrengthValue;

        CmdUpdateAttribute(m_PlayerAttributes.ExpansionMultiple, m_PlayerAttributes.StrengthValue);
    }

   
    [Command]
    public void CmdUpdateAttribute(float expan,int str)
    {
        RpcUpdateAttribute(expan,str);
    }

    [ClientRpc]
    public void RpcUpdateAttribute(float expan, int str)
    {
        transform.localScale = new Vector3(0.1f, 0.1f, 0.1f) * expan;
        m_rigidbody.mass = str;
    }

    public void AddForce(Vector3 power)
    {
        RpcAddForce(power);
    }


    [Command]
    public void CmdAddForce(Vector3 power)
    {
        RpcAddForce(power);
    }


    [ClientRpc]
    public void RpcAddForce(Vector3 power)
    {
        m_rigidbody.AddForce(power);
    }


    public void Reset()
    {
        m_rigidbody.velocity = Vector3.zero;
        transform.position =new Vector3( Vector3.zero.x+Random.Range(-50,50), Vector3.zero.y+5,Vector3.zero.z + Random.Range(-50, 50));
    }


    void CmdCreatMap(MapType mt,List<Vector2> listValue)
    {
        GameObject floorParent = MapManager.instance.CmdCreatMap(mt, listValue);
        //NetworkServer.Spawn(floorParent.gameObject);

        for (int i = 0; i < listValue.Count; i++)
        {
            Debug.Log(listValue[i].ToString());
        }

    }
     
}
